<!DOCTYPE html>
<html lang="de" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abenteuer-Spazierg√§nger</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    <meta name="theme-color" content="#059669">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        amber: { 50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a' },
                        stone: { 300: '#d6d3d1', 400: '#a8a29e', 600: '#57534e', 700: '#44403c', 800: '#292524', 900: '#1c1917' },
                        emerald: { 50: '#ecfdf5', 600: '#059669', 700: '#047857', 800: '#065f46', 900: '#064e3b' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        details[open] summary .arrow-down {
            transform: rotate(180deg);
        }

        .nav-link {
            transition: all 0.3s ease;
        }

        .nav-link.active {
            background-color: #059669;
            color: white;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-amber-50 text-stone-800 dark:bg-stone-950 dark:text-stone-200 transition-colors duration-300">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        <header class="text-center mb-8 relative">
            <button onclick="toggleTheme()"
                class="absolute right-0 top-0 text-2xl p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors"
                title="Theme wechseln">
                <span id="theme-icon">üåô</span>
            </button>
            <h1 class="text-4xl md:text-5xl font-bold text-emerald-800 dark:text-emerald-400">Abenteuer-Spazierg√§nger
            </h1>
            <p class="text-stone-600 dark:text-stone-400 mt-2">Dein Helfer f√ºr magische Spazierg√§nge</p>
        </header>

        <nav
            class="sticky top-2 z-10 bg-white/70 dark:bg-stone-900/80 backdrop-blur-md rounded-xl shadow-md mb-8 p-2 flex justify-center items-center flex-wrap gap-2 transition-colors duration-300">
            <a href="#schnellstart" class="nav-link active text-sm md:text-base font-semibold px-4 py-2 rounded-lg"
                data-section="schnellstart">üöÄ Start</a>
            <a href="#gruppe" class="nav-link text-sm md:text-base font-semibold px-4 py-2 rounded-lg"
                data-section="gruppe">üõ°Ô∏è Gruppe</a>
            <a href="#regeln" class="nav-link text-sm md:text-base font-semibold px-4 py-2 rounded-lg"
                data-section="regeln">üìú Regeln</a>
            <a href="#inspiration" class="nav-link text-sm md:text-base font-semibold px-4 py-2 rounded-lg"
                data-section="inspiration">üí° Ideen</a>
            <a href="#quest" class="nav-link text-sm md:text-base font-semibold px-4 py-2 rounded-lg"
                data-section="quest">üó∫Ô∏è Quest</a>
        </nav>

        <main>
            <section id="schnellstart" class="game-section space-y-8 fade-in">
                <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-lg transition-colors">
                    <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400 mb-4">Das Grundspiel in 60
                        Sekunden</h2>
                    <p class="text-stone-600 dark:text-stone-300 mb-6">Alles, was ihr f√ºr den Anfang braucht. Legt
                        sofort los!</p>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg">
                            <h3 class="font-bold text-lg">1. Verteilt die Rollen</h3>
                            <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">Ein Spielleiter (SL) erz√§hlt, die
                                anderen sind Helden (Ritter, Zauberin) und der Hund ist der treue Begleiter.</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg">
                            <h3 class="font-bold text-lg">2. Definiert eine Quest</h3>
                            <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">Am einfachsten: Eine
                                Sammel-Quest. Findet 3 magische Gegenst√§nde (z.B. eine 'Drachenschuppe' = spitzer
                                Stein).</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg">
                            <h3 class="font-bold text-lg">3. Nutzt die Umgebung</h3>
                            <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">Ein Ast wird zum Zauberstab, eine
                                Pf√ºtze zum Sumpfmonster. Alles ist Teil des Abenteuers!</p>
                        </div>
                        <div class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg">
                            <h3 class="font-bold text-lg">4. L√∂st Proben durch Erz√§hlen</h3>
                            <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">Wenn es schwierig wird,
                                beschreibt der Held kreativ, wie er es schafft. Der SL entscheidet √ºber den Erfolg.</p>
                        </div>
                        <div
                            class="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg col-span-1 md:col-span-2 lg:col-span-2">
                            <h3 class="font-bold text-lg">Das Wichtigste</h3>
                            <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">Es gibt keine falschen Ideen! Das
                                Ziel ist, gemeinsam eine lustige Geschichte zu erleben. Lasst eurer Fantasie freien
                                Lauf.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="gruppe" class="game-section hidden fade-in">
                <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-lg mb-6 transition-colors">

                    <!-- Gruppen-Auswahl -->
                    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                        <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400">Meine Gruppe</h2>
                        <div class="flex items-center gap-2">
                            <select id="group-select" onchange="switchGroup(this.value)"
                                class="bg-white dark:bg-stone-900 border border-stone-300 dark:border-stone-600 rounded-lg px-3 py-2 text-sm outline-none">
                                <!-- Wird dynamisch gef√ºllt -->
                            </select>
                            <button onclick="createNewGroup()"
                                class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-3 py-2 rounded-lg text-sm"
                                title="Neue Gruppe">+ Neu</button>
                            <button onclick="renameCurrentGroup()"
                                class="bg-amber-500 hover:bg-amber-600 text-white font-bold px-3 py-2 rounded-lg text-sm"
                                title="Gruppe umbenennen">‚úèÔ∏è</button>
                            <button onclick="deleteCurrentGroup()"
                                class="bg-red-500 hover:bg-red-600 text-white font-bold px-3 py-2 rounded-lg text-sm"
                                title="Gruppe l√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>

                    <p class="text-stone-600 dark:text-stone-300 mb-4">Verwaltet eure Helden und den treuen Begleiter.
                    </p>

                    <!-- Charakter Liste -->
                    <div id="char-list" class="grid md:grid-cols-2 gap-4 mb-6">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <button onclick="addCharacter()"
                            class="bg-stone-200 dark:bg-stone-700 hover:bg-stone-300 dark:hover:bg-stone-600 text-stone-700 dark:text-stone-200 font-bold py-3 px-4 rounded-lg border-2 border-dashed border-stone-400 dark:border-stone-500 transition-colors">
                            + Leer</button>
                        <button onclick="generateRandomChar()"
                            class="bg-purple-100 dark:bg-purple-900/30 hover:bg-purple-200 dark:hover:bg-purple-900/50 text-purple-800 dark:text-purple-300 font-bold py-3 px-4 rounded-lg border-2 border-dashed border-purple-300 dark:border-purple-700 transition-colors">
                            üé≤ W√ºrfeln</button>
                    </div>

                    <h3 class="text-xl font-bold text-emerald-800 dark:text-emerald-400 mt-8 mb-4">Gemeinsames Inventar
                    </h3>
                    <div id="inventory-list" class="grid grid-cols-3 md:grid-cols-4 gap-2 mb-4">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </section>

            <section id="regeln" class="game-section space-y-6 hidden fade-in">
                <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-lg transition-colors">
                    <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400 mb-4">Regelwerk & Module</h2>
                    <p class="text-stone-600 dark:text-stone-300 mb-6">Hier findet ihr die Details und optionale Regeln,
                        um das Spiel spannender zu machen.</p>
                    <details class="bg-amber-100/50 dark:bg-stone-700/30 p-4 rounded-lg mb-3 transition-colors">
                        <summary
                            class="font-semibold cursor-pointer flex justify-between items-center text-stone-800 dark:text-stone-200">
                            Modul A: Konflikt-Proben <span class="arrow-down transition-transform duration-300">‚ñº</span>
                        </summary>
                        <div
                            class="mt-4 text-stone-700 dark:text-stone-300 space-y-3 border-t border-amber-200 dark:border-stone-600 pt-3">
                            <p>Nutzt diese, wenn der Ausgang einer Aktion vom Zufall oder Geschick abh√§ngen soll.</p>
                            <p><strong>Schere, Stein, Papier:</strong> Held spielt gegen SL. Sieg = Aktion gelingt
                                super. Niederlage = Aktion misslingt mit lustiger Konsequenz. Unentschieden =
                                Teilerfolg.</p>
                            <p><strong>Gl√ºcks-Alternativen:</strong> "Gerade oder Ungerade" mit Fingern oder das
                                "Farben-Orakel" (n√§chstes Auto).</p>
                            <p><strong>Geschicklichkeits-Alternativen:</strong> Eine Strecke balancieren oder einen
                                Tannenzapfen auf ein Ziel werfen.</p>
                        </div>
                    </details>
                    <details class="bg-amber-100/50 dark:bg-stone-700/30 p-4 rounded-lg mb-3 transition-colors">
                        <summary
                            class="font-semibold cursor-pointer flex justify-between items-center text-stone-800 dark:text-stone-200">
                            Modul B: Spannungs-Mechaniken <span
                                class="arrow-down transition-transform duration-300">‚ñº</span>
                        </summary>
                        <div
                            class="mt-4 text-stone-700 dark:text-stone-300 space-y-3 border-t border-amber-200 dark:border-stone-600 pt-3">
                            <p><strong>Fortschritts-Uhr:</strong> Legt ein echtes Ziel als Timer fest.
                                <br><em>Zeitdruck:</em> "Wir m√ºssen X finden, bevor wir die Br√ºcke erreichen!"
                                <br><em>Anh√§ufung:</em> "Bei jedem Fehlschlag ist der b√∂se Magier einen Schritt n√§her!"
                            </p>
                        </div>
                    </details>
                    <details class="bg-amber-100/50 dark:bg-stone-700/30 p-4 rounded-lg transition-colors">
                        <summary
                            class="font-semibold cursor-pointer flex justify-between items-center text-stone-800 dark:text-stone-200">
                            Modul C: Konsequenz-Mechaniken <span
                                class="arrow-down transition-transform duration-300">‚ñº</span>
                        </summary>
                        <div
                            class="mt-4 text-stone-700 dark:text-stone-300 space-y-3 border-t border-amber-200 dark:border-stone-600 pt-3">
                            <p><strong>Zust√§nde:</strong> Ein Fehlschlag gibt einen lustigen Zustand.
                                <br><em>Negativ:</em> "'Juckreiz' erwischt! Du musst bis auf Weiteres auf einem Bein
                                h√ºpfen." <br><em>Positiv:</em> "'Stark' durch einen Schluck aus dem Bach! Deine n√§chste
                                Probe gelingt automatisch."
                            </p>
                            <p><strong>Scheitern mit Fortschritt:</strong> Ein Fehlschlag stoppt nie die Geschichte! Er
                                macht sie nur interessanter. Statt "Du schaffst es nicht", sag lieber "Du schaffst es,
                                aber das laute Platschen weckt den Kobold!".</p>
                        </div>
                    </details>
                </div>
            </section>

            <section id="inspiration" class="game-section hidden fade-in">
                <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-lg transition-colors">
                    <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400 mb-4">Ideen-Generator</h2>
                    <p class="text-stone-600 dark:text-stone-300 mb-6">W√§hlt eure Umgebung und holt euch spontane Ideen
                        f√ºr magische Verwandlungen.</p>
                    <div class="flex flex-wrap gap-3 mb-6">
                        <button class="env-btn bg-emerald-600 text-white font-semibold px-4 py-2 rounded-lg"
                            data-env="wald">üå≥ Wald</button>
                        <button
                            class="env-btn bg-stone-400 hover:bg-stone-500 text-white font-semibold px-4 py-2 rounded-lg"
                            data-env="quartier">üè° Quartier</button>
                        <button
                            class="env-btn bg-stone-400 hover:bg-stone-500 text-white font-semibold px-4 py-2 rounded-lg"
                            data-env="stadt">üèôÔ∏è Stadt</button>
                        <button
                            class="env-btn bg-stone-400 hover:bg-stone-500 text-white font-semibold px-4 py-2 rounded-lg"
                            data-env="altstadt">üè∞ Altstadt</button>
                    </div>
                    <div id="inspiration-output" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </section>

            <section id="quest" class="game-section hidden fade-in">
                <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-lg transition-colors">
                    <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400 mb-4">Quest-Generator</h2>
                    <p class="text-stone-600 dark:text-stone-300 mb-6">Keine Idee f√ºr heute? Lasst euch eine
                        Sammel-Quest erstellen!</p>
                    <div class="flex flex-wrap items-center gap-4 mb-6">
                        <p class="font-semibold">W√§hlt eine Umgebung:</p>
                        <select id="quest-env-select"
                            class="bg-white dark:bg-stone-900 border border-stone-300 dark:border-stone-600 rounded-lg px-3 py-2 outline-none">
                            <option value="wald">Wald</option>
                            <option value="quartier">Quartier</option>
                            <option value="stadt">Stadt</option>
                            <option value="altstadt">Altstadt</option>
                        </select>
                        <button id="generate-quest-btn"
                            class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold px-5 py-2 rounded-lg">Quest
                            erstellen</button>
                    </div>
                    <div id="quest-output"
                        class="bg-amber-100/50 dark:bg-stone-700/30 p-6 rounded-lg min-h-[150px] transition-colors">
                        <h3 class="font-bold text-lg text-emerald-800 dark:text-emerald-400">Eure heutige Mission:</h3>
                        <p class="text-stone-600 dark:text-stone-400 italic">W√§hlt eine Umgebung und klickt auf "Quest
                            erstellen", um eure Aufgabe zu erhalten.</p>
                        <ul id="quest-list" class="list-none mt-4 space-y-2"></ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Theme Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
                document.addEventListener('DOMContentLoaded', () => {
                    document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
                });
            }
        })();

        // PWA Registrar
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registriert!', reg))
                    .catch(err => console.log('SW Fehler:', err));
            });
        }

        // --- Data Management & Persistence ---
        const STORE_KEY = 'wald_rpg_save_v2';

        // Default group template
        function createDefaultGroup(name) {
            return {
                id: Date.now(),
                name: name,
                characters: [
                    { id: 1, name: 'Held 1', class: 'Krieger', hp: 3, maxHp: 3, mana: 0 },
                    { id: 2, name: 'Bello', class: 'Arkaner Sucher', hp: 3, maxHp: 3, mana: 5 }
                ],
                inventory: [],
                currentQuest: null
            };
        }

        let appState = {
            groups: [createDefaultGroup('Abenteuergruppe 1')],
            activeGroupId: null,
            currentQuest: null
        };

        // Derived: current group
        function getCurrentGroup() {
            return appState.groups.find(g => g.id === appState.activeGroupId) || appState.groups[0];
        }

        function loadGame() {
            const saved = localStorage.getItem(STORE_KEY);
            if (saved) {
                appState = JSON.parse(saved);
                // Ensure at least one group exists
                if (!appState.groups || appState.groups.length === 0) {
                    appState.groups = [createDefaultGroup('Abenteuergruppe 1')];
                }
                if (!appState.activeGroupId) {
                    appState.activeGroupId = appState.groups[0].id;
                }
            } else {
                appState.activeGroupId = appState.groups[0].id;
                saveGame();
            }
            renderGroupSelector();
            renderCharacters();
            renderInventory();
            const group = getCurrentGroup();
            if (group && group.currentQuest) {
                renderQuest(group.currentQuest);
            }
        }

        function saveGame() {
            localStorage.setItem(STORE_KEY, JSON.stringify(appState));
        }

        // --- Group Management ---
        function renderGroupSelector() {
            const select = document.getElementById('group-select');
            select.innerHTML = '';
            appState.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                if (group.id === appState.activeGroupId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        window.switchGroup = function (groupId) {
            appState.activeGroupId = parseInt(groupId);
            saveGame();
            renderCharacters();
            renderInventory();
            const group = getCurrentGroup();
            if (group && group.currentQuest) {
                renderQuest(group.currentQuest);
            } else {
                // Reset quest display
                const questOutput = document.getElementById('quest-output');
                const questList = document.getElementById('quest-list');
                questOutput.querySelector('h3').textContent = 'Eure heutige Mission:';
                questList.innerHTML = '';
            }
        };

        // --- Modal Logic ---
        let currentModalConfirmHandler = null;

        window.showInputModal = function (title, defaultValue, placeholder, confirmCallback) {
            const modal = document.getElementById('input-modal');
            const input = document.getElementById('modal-input');
            const titleEl = document.getElementById('modal-title');
            const confirmBtn = document.getElementById('modal-confirm');
            const modalCheck = modal.querySelector('div'); // The inner container

            titleEl.textContent = title;
            input.value = defaultValue || '';
            input.placeholder = placeholder || '';

            // Clean up old handler
            if (currentModalConfirmHandler) {
                confirmBtn.removeEventListener('click', currentModalConfirmHandler);
            }

            // Define new handler
            currentModalConfirmHandler = () => {
                const val = input.value.trim();
                if (val) {
                    confirmCallback(val);
                    closeModal();
                }
            };

            confirmBtn.addEventListener('click', currentModalConfirmHandler);

            // Handle Enter key
            input.onkeydown = (e) => {
                if (e.key === 'Enter') currentModalConfirmHandler();
                if (e.key === 'Escape') closeModal();
            };

            // Show modal with animation
            modal.classList.remove('hidden', 'pointer-events-none', 'opacity-0');
            modalCheck.classList.remove('scale-95');
            modalCheck.classList.add('scale-100');

            setTimeout(() => input.focus(), 50);
        };

        window.closeModal = function () {
            const modal = document.getElementById('input-modal');
            const modalCheck = modal.querySelector('div');

            modal.classList.add('opacity-0', 'pointer-events-none');
            modalCheck.classList.remove('scale-100');
            modalCheck.classList.add('scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200); // Wait for transition
        };

        window.createNewGroup = function () {
            showInputModal('Name der neuen Gruppe', 'Neue Gruppe', 'Gruppenname', (name) => {
                const newGroup = createDefaultGroup(name);
                appState.groups.push(newGroup);
                appState.activeGroupId = newGroup.id;
                saveGame();
                renderGroupSelector();
                renderCharacters();
                renderInventory();
            });
        };

        window.deleteCurrentGroup = function () {
            if (appState.groups.length <= 1) {
                alert('Du kannst die letzte Gruppe nicht l√∂schen!');
                return;
            }
            const currentId = appState.activeGroupId;
            appState.groups = appState.groups.filter(g => g.id !== currentId);
            appState.activeGroupId = appState.groups[0].id;
            saveGame();
            renderGroupSelector();
            renderCharacters();
            saveGame();
            renderGroupSelector();
            renderCharacters();
            renderInventory();
        };

        window.renameCurrentGroup = function () {
            const group = getCurrentGroup();
            if (!group) return;
            showInputModal('Neuer Name f√ºr die Gruppe', group.name, 'Gruppenname', (newName) => {
                group.name = newName;
                saveGame();
                renderGroupSelector();
            });
        };

        // --- Character Logic ---
        function generateRandomChar() {
            const backgrounds = window.characterBackgrounds || [];
            if (backgrounds.length === 0) return addCharacter(); // Fallback

            const randomBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];
            const group = getCurrentGroup();
            if (!group) return;

            // Add character
            const newChar = {
                id: Date.now(),
                name: 'Neuer Held',
                class: randomBg.name,
                hp: 3,
                maxHp: 3,
                mana: 0,
                // Personal inventory slots (3)
                inventory: [randomBg.item + " (" + randomBg.name + ")"]
            };
            group.characters.push(newChar);

            saveGame();
            renderCharacters();
            renderInventory();
        }
        function renderCharacters() {
            const list = document.getElementById('char-list');
            list.innerHTML = '';
            const group = getCurrentGroup();
            if (!group) return;

            group.characters.forEach(char => {
                const card = document.createElement('div');
                card.className = 'bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900 p-4 rounded-lg relative transition-colors';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <input type="text" value="${char.name}" data-char-id="${char.id}" data-field="name" class="char-input font-bold text-lg bg-transparent border-b border-transparent focus:border-emerald-500 outline-none w-2/3 text-stone-800 dark:text-stone-200">
                            <input type="text" value="${char.class}" data-char-id="${char.id}" data-field="class" class="char-input text-sm text-stone-500 dark:text-stone-400 bg-transparent block w-full">
                        </div>
                        <button data-delete-char="${char.id}" class="text-red-400 hover:text-red-600 text-lg p-1" title="Held l√∂schen">‚ùå</button>
                    </div>
                    
                    <div class="flex items-center gap-4 mt-3">
                    <div class="flex items-center gap-4 mt-3">
                         <div class="flex-1">
                            <label class="text-xs font-bold text-red-700 dark:text-red-400 uppercase">HP (Puste)</label>
                            <div class="flex items-center gap-2">
                                <button data-mod-stat="${char.id}" data-stat="hp" data-amount="-1" class="w-8 h-8 rounded-full bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 font-bold hover:bg-red-200 dark:hover:bg-red-800 transition-colors">-</button>
                                <span class="font-mono text-xl w-6 text-center text-stone-800 dark:text-stone-200">${char.hp}</span>
                                <button data-mod-stat="${char.id}" data-stat="hp" data-amount="1" class="w-8 h-8 rounded-full bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 font-bold hover:bg-emerald-200 dark:hover:bg-emerald-800 transition-colors">+</button>
                            </div>
                        </div>
                        <div class="flex-1">
                             <label class="text-xs font-bold text-blue-700 dark:text-blue-400 uppercase">Wille (WIL)</label>
                            <div class="flex items-center gap-2">
                                <button data-mod-stat="${char.id}" data-stat="mana" data-amount="-1" class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 font-bold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">-</button>
                                <span class="font-mono text-xl w-6 text-center text-stone-800 dark:text-stone-200">${char.mana}</span>
                                <button data-mod-stat="${char.id}" data-stat="mana" data-amount="1" class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 font-bold hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">+</button>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Personal Slots -->
                    <div class="mt-3 pt-3 border-t border-emerald-100 dark:border-emerald-800">
                        <label class="text-xs font-bold text-stone-500 dark:text-stone-400 uppercase mb-1 block">Ausr√ºstung (3 Slots)</label>
                        <div class="grid grid-cols-3 gap-2">
                            ${[0, 1, 2].map(i => {
                    const item = (char.inventory && char.inventory[i]) ? char.inventory[i] : '';
                    if (item) {
                        return `
                                    <div class="aspect-square bg-white dark:bg-stone-800 border border-emerald-500 rounded flex items-center justify-center p-1 relative group text-xs text-center overflow-hidden">
                                        ${item}
                                        <button onclick="removeCharItem(${char.id}, ${i})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center lg:opacity-0 lg:group-hover:opacity-100 transition-opacity text-[10px]">√ó</button>
                                    </div>`;
                    } else {
                        return `
                                    <div class="aspect-square bg-transparent border border-dashed border-stone-300 dark:border-stone-600 rounded flex items-center justify-center text-stone-300 cursor-pointer hover:bg-black/5 dark:hover:bg-white/5" onclick="addCharItem(${char.id})">
                                        +
                                    </div>`;
                    }
                }).join('')}
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });

            // Event delegation for new character functions
            window.removeCharItem = function (charId, slotIndex) {
                const group = getCurrentGroup();
                if (!group) return;
                const char = group.characters.find(c => c.id === charId);
                if (char && char.inventory) {
                    char.inventory.splice(slotIndex, 1);
                    saveGame();
                    renderCharacters();
                }
            };

            window.addCharItem = function (charId) {
                const group = getCurrentGroup();
                if (!group) return;
                const char = group.characters.find(c => c.id === charId);
                if (char) {
                    if (!char.inventory) char.inventory = [];
                    if (char.inventory.length >= 3) return;

                    showInputModal('Neues Item f√ºr ' + char.name, '', 'Item Name', (newItem) => {
                        char.inventory.push(newItem);
                        saveGame();
                        renderCharacters();
                    });
                }
            };

            // Event delegation for character actions (keep existing)
            list.onclick = function (e) {
                const deleteBtn = e.target.closest('[data-delete-char]');
                if (deleteBtn) {
                    const id = parseInt(deleteBtn.dataset.deleteChar);
                    const group = getCurrentGroup();
                    if (group) {
                        group.characters = group.characters.filter(c => c.id !== id);
                        saveGame();
                        renderCharacters();
                    }
                    return;
                }

                const modBtn = e.target.closest('[data-mod-stat]');
                if (modBtn) {
                    const id = parseInt(modBtn.dataset.modStat);
                    const stat = modBtn.dataset.stat;
                    const amount = parseInt(modBtn.dataset.amount);
                    const group = getCurrentGroup();
                    if (group) {
                        const char = group.characters.find(c => c.id === id);
                        if (char) {
                            char[stat] = Math.max(0, char[stat] + amount);
                            saveGame();
                            renderCharacters();
                        }
                    }
                }
            };

            list.onchange = function (e) {
                if (e.target.classList.contains('char-input')) {
                    const id = parseInt(e.target.dataset.charId);
                    const field = e.target.dataset.field;
                    const value = e.target.value;
                    const group = getCurrentGroup();
                    if (group) {
                        const char = group.characters.find(c => c.id === id);
                        if (char) {
                            char[field] = value;
                            saveGame();
                        }
                    }
                }
            };
        }

        window.addCharacter = function () {
            const group = getCurrentGroup();
            if (!group) return;
            group.characters.push({
                id: Date.now(),
                name: 'Neuer Held',
                class: 'Abenteurer',
                hp: 3,
                maxHp: 3,
                mana: 0,
                inventory: [] // Init empty inventory
            });
            saveGame();
            renderCharacters();
            renderInventory();
        };

        window.removeChar = function (id) {
            if (confirm('Das ist permanent, sind sie sicher?')) {
                const group = getCurrentGroup();
                if (!group) return;
                group.characters = group.characters.filter(c => c.id !== id);
                saveGame();
                renderCharacters();
            }
        };

        window.updateChar = function (id, field, value) {
            const group = getCurrentGroup();
            if (!group) return;
            const char = group.characters.find(c => c.id === id);
            if (char) {
                char[field] = value;
                saveGame();
            }
        };

        window.modStat = function (id, stat, amount) {
            const group = getCurrentGroup();
            if (!group) return;
            const char = group.characters.find(c => c.id === id);
            if (char) {
                char[stat] = Math.max(0, char[stat] + amount);
                saveGame();
                renderCharacters();
            }
        };

        // --- Inventory Logic ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            list.className = 'grid grid-cols-3 md:grid-cols-4 gap-2 mb-4'; // Grid layout

            const group = getCurrentGroup();
            if (!group) return;

            // Ensure limit
            const MAX_SLOTS = 12;

            for (let i = 0; i < MAX_SLOTS; i++) {
                const item = group.inventory[i];
                const slot = document.createElement('div');

                if (item) {
                    slot.className = 'aspect-square bg-white dark:bg-stone-800 border-2 border-solid border-emerald-500 rounded-lg flex items-center justify-center p-2 relative group transition-all shadow-sm';
                    slot.innerHTML = `<span class="text-xs text-center font-medium text-stone-800 dark:text-stone-200 break-words w-full overflow-hidden text-ellipsis max-h-full">${item}</span>
                                      <button onclick="removeItem(${i})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-100 lg:opacity-0 lg:group-hover:opacity-100 transition-opacity shadow-md hover:scale-110">√ó</button>`;
                } else {
                    slot.className = 'aspect-square bg-stone-50 dark:bg-stone-900/50 border-2 border-dashed border-stone-300 dark:border-stone-700 rounded-lg flex items-center justify-center relative group cursor-pointer hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:border-emerald-300 dark:hover:border-emerald-700 transition-all';
                    slot.innerHTML = `<span class="text-stone-300 dark:text-stone-600 text-3xl font-light group-hover:text-emerald-400 dark:group-hover:text-emerald-500 transition-colors">+</span>`;
                    slot.onclick = () => addGroupItem();
                }
                list.appendChild(slot);
            }
        }

        window.addGroupItem = function () {
            const group = getCurrentGroup();
            if (!group) return;
            if (group.inventory.length >= 12) return;

            showInputModal('Neuer Gegenstand', '', 'Item Name', (val) => {
                group.inventory.push(val);
                saveGame();
                renderInventory();
            });
        };

        window.removeItem = function (index) {
            const group = getCurrentGroup();
            if (!group) return;
            group.inventory.splice(index, 1);
            saveGame();
            renderInventory();
        };

        function renderQuest(questItems) {
            const questOutput = document.getElementById('quest-output');
            const questList = document.getElementById('quest-list');

            questOutput.querySelector('h3').textContent = "Eure laufende Mission:";
            const p = questOutput.querySelector('p');
            if (p) p.remove();
            questList.innerHTML = '';

            questItems.forEach((item) => {
                const li = document.createElement('li');
                li.className = 'flex items-center fade-in text-stone-800 dark:text-stone-200';
                li.innerHTML = `
                   <span class="text-emerald-600 dark:text-emerald-400 mr-3 text-xl">‚úîÔ∏è</span> 
                   <span>Finde eine <strong>"${item.fantasy.split(',')[0]}"</strong> (z.B. ${item.item})</span>
                `;
                questList.appendChild(li);
            });
        }


        // --- UI Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            loadGame();

            const inspirationData = {
                wald: [
                    { item: "Spitzer Stein", fantasy: "Drachenschuppe, Pfeilspitze, Splitter eines magischen Kristalls" },
                    { item: "Runder Kieselstein", fantasy: "Kobold-Gold, versteinertes Troll-Auge" },
                    { item: "Ast (klein)", fantasy: "Zauberstab, Dolch, Schl√ºssel" },
                    { item: "Tannenzapfen", fantasy: "Drachen-Ei, 'Knirsch-Granate'" },
                    { item: "Eichel / Kastanie", fantasy: "Juwel des Eichh√∂rnchen-K√∂nigs, Zwergen-Helm" },
                    { item: "Moos", fantasy: "Bart des Baumgeistes, Verbandszeug" },
                    { item: "Feder", fantasy: "Feder eines Greifen, Schreibfeder f√ºr unsichtbare Tinte" },
                    { item: "Blatt (bunt)", fantasy: "Blutstropfen eines Einhorns, Flammen-Amulett" },
                    { item: "Pilz", fantasy: "Haus eines Zwerges, Giftfalle" },
                    { item: "Harz am Baum", fantasy: "Tr√§ne des Baumes, Elfen-Bernstein" },
                    { item: "Leeres Schneckenhaus", fantasy: "Helm f√ºr einen Gnom, Trinkbecher" }
                ],
                quartier: [
                    { item: "Blume", fantasy: "Zutat f√ºr einen Heiltrank, Sonnensymbol" },
                    { item: "Gullideckel", fantasy: "Schild eines Riesen, Siegel zur Unterwelt" },
                    { item: "Kleine Mauer", fantasy: "Ruine einer alten Festung" },
                    { item: "Gartenzaun", fantasy: "Palisade der Ortschaft" },
                    { item: "Strassenlaterne", fantasy: "Wachturm der Stadtgarde" },
                    { item: "Briefkasten", fantasy: "Geheimer Quest-Geber" },
                    { item: "Weisser Kieselstein", fantasy: "Zahn eines Eis-Drachen, Mond-Splitter" },
                    { item: "Gartenschlauch", fantasy: "Schlafende Seeschlange" }
                ],
                stadt: [
                    { item: "M√ºnze", fantasy: "Antike Dublone, verfluchtes Gold" },
                    { item: "Kronkorken", fantasy: "Amulett einer unbekannten Gilde" },
                    { item: "Brunnen", fantasy: "Heilquelle, Portal in die Wasserwelt" },
                    { item: "Statue / Skulptur", fantasy: "Versteinerter Held (oder Troll)" },
                    { item: "Treppe", fantasy: "Himmelsleiter, Abstieg in die Gruft" },
                    { item: "Br√ºcke", fantasy: "Troll-Br√ºcke (Zoll entrichten!)" },
                    { item: "Ampel (Rot/Gr√ºn)", fantasy: "Magisches Orakel (Rot = Gefahr, Gr√ºn = Sicher)" },
                    { item: "Zebrastreifen", fantasy: "Sicherer Pfad √ºber den 'Lava-Fluss'" }
                ],
                altstadt: [
                    { item: "Brunnen", fantasy: "Quelle der Wahrheit, Tr√§nen-Spiegel, Gef√§ngnis eines Wassergeistes" },
                    { item: "Enge Gasse", fantasy: "Diebes-Pfad (Schleich-Probe), Echo-Gasse (Fl√ºstern!)" },
                    { item: "Wasserspeier (Gargoyle)", fantasy: "Versteinerter W√§chter, Orakel des Steins (zeigt die Richtung)" },
                    { item: "Torbogen", fantasy: "Wahrheits-Schwelle (wer l√ºgt, bleibt stecken), Zeit-Portal" },
                    { item: "Kopfsteinpflaster", fantasy: "Runen-Pfad (nicht auf falsche Steine treten), Drachenschuppen-Pflaster" },
                    { item: "Alte Holzt√ºr", fantasy: "Gilden-Tor (Passwort n√∂tig), Sprechendes Portal (stellt ein R√§tsel)" },
                    { item: "Kellerfenster / Gitter", fantasy: "Atemloch des Monsters, Gef√§ngnis-Gitter (ein Gefangener bittet um Hilfe)" }
                ]
            };

            const characterBackgrounds = [
                { name: "Waldl√§ufer", item: "Kompass" },
                { name: "Kr√§uterkundiger", item: "Pilzbuch" },
                { name: "Dieb", item: "Dietrich" },
                { name: "Ritter", item: "Holzschwert" },
                { name: "Barde", item: "Fl√∂te" },
                { name: "Gelehrter", item: "Notizbuch" },
                { name: "Magier", item: "Zauberstab (Ast)" },
                { name: "H√§ndler", item: "M√ºnzbeutel" },
                { name: "Barbier", item: "Verbandszeug" },
                { name: "Bestienmeister", item: "Leckerlis" },
                { name: "Alchemist", item: "Leere Flasche" },
                { name: "Gl√ºcksritter", item: "W√ºrfel" }
            ];

            // Make backgrounds available globally for the generator
            window.characterBackgrounds = characterBackgrounds;

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.game-section');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.dataset.section;
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.target.classList.add('active');
                    sections.forEach(section => {
                        if (section.id === targetId) {
                            section.classList.remove('hidden');
                        } else {
                            section.classList.add('hidden');
                        }
                    });
                    window.scrollTo({ top: document.querySelector('main').offsetTop - 80, behavior: 'smooth' });
                });
            });

            const inspirationOutput = document.getElementById('inspiration-output');
            const envButtons = document.querySelectorAll('.env-btn');

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function generateInspiration(env) {
                inspirationOutput.innerHTML = '';
                const data = inspirationData[env] || [];
                const shuffledData = shuffleArray([...data]);
                shuffledData.slice(0, 6).forEach(d => {
                    const card = document.createElement('div');
                    card.className = 'bg-amber-100/50 dark:bg-stone-700/30 p-4 rounded-lg fade-in transition-colors';
                    card.innerHTML = `
                        <h4 class="font-bold text-emerald-800 dark:text-emerald-400">${d.item}</h4>
                        <p class="text-sm text-stone-700 dark:text-stone-300 mt-1">${d.fantasy}</p>
                    `;
                    inspirationOutput.appendChild(card);
                });
            }

            envButtons.forEach(button => {
                button.addEventListener('click', () => {
                    envButtons.forEach(btn => {
                        btn.classList.remove('bg-emerald-600');
                        btn.classList.add('bg-stone-400', 'hover:bg-stone-500');
                    });
                    button.classList.add('bg-emerald-600');
                    button.classList.remove('bg-stone-400', 'hover:bg-stone-500');
                    generateInspiration(button.dataset.env);
                });
            });

            const generateQuestBtn = document.getElementById('generate-quest-btn');
            const questEnvSelect = document.getElementById('quest-env-select');

            generateQuestBtn.addEventListener('click', () => {
                const env = questEnvSelect.value;
                const data = inspirationData[env] || [];
                const shuffledData = shuffleArray([...data]);
                const newQuestItems = shuffledData.slice(0, 3);

                // Save Quest to current group
                const group = getCurrentGroup();
                if (group) {
                    group.currentQuest = newQuestItems;
                    saveGame();
                }
                renderQuest(newQuestItems);
            });

            generateInspiration('wald');
        });
    </script>
    <!-- Input Modal -->
    <div id="input-modal"
        class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 transition-opacity opacity-0 pointer-events-none"
        style="transition: opacity 0.2s ease-in-out;">
        <div class="bg-white dark:bg-stone-800 p-6 rounded-xl shadow-xl w-full max-w-sm mx-4 transform scale-95 transition-transform"
            style="transition: transform 0.2s ease-in-out;">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-emerald-800 dark:text-emerald-400">Eingabe</h3>
            <input type="text" id="modal-input"
                class="w-full p-2 border border-stone-300 dark:border-stone-600 rounded mb-4 bg-white dark:bg-stone-900 text-stone-900 dark:text-white outline-none focus:border-emerald-500"
                autocomplete="off">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()"
                    class="px-4 py-2 rounded text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 font-medium">Abbrechen</button>
                <button id="modal-confirm"
                    class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700 font-bold shadow-sm">OK</button>
            </div>
        </div>
    </div>
</body>

</html>